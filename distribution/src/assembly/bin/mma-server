#!/bin/bash

set -e

DIR="$( cd "$( dirname "${BASH_SOURCE[0]}" )" >/dev/null 2>&1 && pwd )"
export MMA_HOME=$(dirname ${DIR})

function GET_MMA_SERVER_PID() {
  if type lsof > /dev/null; then
  # TODO: get MMA server API port from MMA server config
    PID=$(lsof -t -i:18889)
  else
    PID=$(ps ax | grep -i 'MmaServerMain' | grep java | grep -v grep | awk '{print $1}')
  fi
  echo ${PID}
}

PID=$(GET_MMA_SERVER_PID)

if [ -z "${PID}" ]; then
  echo "Start MMA server..."
  echo "This may take a few seconds"
  mkdir -p "${MMA_HOME}/log/"
  nohup java -Dlog4j.configurationFile="$MMA_HOME/res/mma_server_log4j2.xml" \
     -cp "$MMA_HOME/lib/*" \
     com.aliyun.odps.mma.server.MmaServerMain "$@" > "${MMA_HOME}/log/nohup.log" 2>&1 &
  # wait since it may take a few seconds for MMA API server to initialize
  sleep 10
  PID=$(GET_MMA_SERVER_PID)
  if [ -z "${PID}" ]; then
    echo "Failed to start MMA server, please see the logs in ${MMA_HOME}/log for detailed information"
  else
    echo "MMA server started, PID=${PID}"
  fi
else
  echo "MMA server already started, PID=${PID}"
fi
